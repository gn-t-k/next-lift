name: Production Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Vercel (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Check Environment Variables
        env:
          # ビルド時に必要な環境変数
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          APPLE_CLIENT_ID: ${{ secrets.APPLE_CLIENT_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_PRIVATE_KEY: ${{ secrets.APPLE_PRIVATE_KEY }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          # デプロイ時に必要な環境変数（本番用）
          BETTER_AUTH_URL: ${{ secrets.BETTER_AUTH_URL }}
          TURSO_AUTH_DATABASE_URL: ${{ secrets.TURSO_AUTH_DATABASE_URL }}
          TURSO_AUTH_DATABASE_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_DATABASE_AUTH_TOKEN }}
        run: |
          # デプロイ前に環境変数を検証
          pnpm --filter @next-lift/env check || {
            echo "::error::環境変数の検証に失敗しました。GitHub Secretsの設定を確認してください。"
            exit 1
          }

      - name: Run Database Migration
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORG_SLUG: ${{ secrets.TURSO_ORG_SLUG }}
        run: |
          DB_NAME="next-lift-production-auth"

          # データベース情報を取得してURLを構築
          GET_RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}")
          DB_HOSTNAME=$(echo "${GET_RESPONSE}" | jq -r '.database.Hostname')
          DB_URL="libsql://${DB_HOSTNAME}"

          # 一時トークンを取得（1時間有効）
          TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}/auth/tokens?expiration=1h")
          DB_AUTH_TOKEN=$(echo "${TOKEN_RESPONSE}" | jq -r '.jwt')

          # マイグレーションを実行
          cd packages/authentication
          TURSO_AUTH_DATABASE_URL="${DB_URL}" \
          TURSO_AUTH_DATABASE_AUTH_TOKEN="${DB_AUTH_TOKEN}" \
          pnpm migration:apply
          echo "Migration completed successfully"

      - name: Deploy to Vercel
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npx vercel deploy --prod --token=$VERCEL_TOKEN > deployment-url.txt
          echo "DEPLOYMENT_URL=$(cat deployment-url.txt)" >> $GITHUB_ENV
