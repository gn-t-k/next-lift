name: Production Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Vercel (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Run Database Migration
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORG_SLUG: ${{ secrets.TURSO_ORG_SLUG }}
        run: |
          DB_NAME="next-lift-production-auth"

          # データベース情報を取得してURLを構築
          GET_RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}")
          DB_HOSTNAME=$(echo "${GET_RESPONSE}" | jq -r '.database.Hostname')
          DB_URL="libsql://${DB_HOSTNAME}"

          # 一時トークンを取得（1時間有効）
          TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}/auth/tokens?expiration=1h")
          DB_AUTH_TOKEN=$(echo "${TOKEN_RESPONSE}" | jq -r '.jwt')

          # マイグレーションを実行
          cd packages/authentication
          TURSO_AUTH_DATABASE_URL="${DB_URL}" \
          TURSO_AUTH_DATABASE_AUTH_TOKEN="${DB_AUTH_TOKEN}" \
          pnpm migration:apply
          echo "Migration completed successfully"

      - name: Deploy to Vercel
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npx vercel deploy --prod --token=$VERCEL_TOKEN > deployment-url.txt
          echo "DEPLOYMENT_URL=$(cat deployment-url.txt)" >> $GITHUB_ENV
