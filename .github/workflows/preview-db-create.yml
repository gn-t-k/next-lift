name: Preview Database Create

on:
  pull_request:
    types: [opened, reopened]

jobs:
  create-preview-db:
    name: Create Preview Database
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Create Preview Database
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORG_SLUG: ${{ secrets.TURSO_ORG_SLUG }}
          TURSO_GROUP: ${{ secrets.TURSO_GROUP }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          DB_NAME="preview-pr${PR_NUMBER}-auth"

          # データベースを作成
          RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"${DB_NAME}\",\"group\":\"${TURSO_GROUP}\"}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases")

          echo "Database creation response: ${RESPONSE}"

          # データベースのURLを取得
          DB_HOSTNAME=$(echo "${RESPONSE}" | jq -r '.database.Hostname')
          DB_URL="libsql://${DB_HOSTNAME}"

          echo "DB_URL=${DB_URL}" >> $GITHUB_ENV
          echo "DB_NAME=${DB_NAME}" >> $GITHUB_ENV

      - name: Create Database Token
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORG_SLUG: ${{ secrets.TURSO_ORG_SLUG }}
        run: |
          # データベースアクセス用のトークンを作成
          TOKEN_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}/auth/tokens?expiration=never")

          echo "Token creation response (hidden for security)"

          # トークンを取得
          DB_AUTH_TOKEN=$(echo "${TOKEN_RESPONSE}" | jq -r '.jwt')

          echo "DB_AUTH_TOKEN=${DB_AUTH_TOKEN}" >> $GITHUB_ENV

      - name: Set Vercel Environment Variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Vercelのプレビュー環境に環境変数を設定
          # TURSO_AUTH_DATABASE_URL
          curl -X POST \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"key\":\"TURSO_AUTH_DATABASE_URL\",\"value\":\"${DB_URL}\",\"type\":\"encrypted\",\"target\":[\"preview\"],\"gitBranch\":\"${{ github.head_ref }}\"}" \
            "https://api.vercel.com/v10/projects/${VERCEL_PROJECT_ID}/env"

          # TURSO_AUTH_DATABASE_AUTH_TOKEN
          curl -X POST \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"key\":\"TURSO_AUTH_DATABASE_AUTH_TOKEN\",\"value\":\"${DB_AUTH_TOKEN}\",\"type\":\"encrypted\",\"target\":[\"preview\"],\"gitBranch\":\"${{ github.head_ref }}\"}" \
            "https://api.vercel.com/v10/projects/${VERCEL_PROJECT_ID}/env"

      - name: Comment PR with Database Info
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          DB_NAME: ${{ env.DB_NAME }}
          DB_URL: ${{ env.DB_URL }}
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🗄️ Preview Database Created\n\n✅ プレビュー環境用のデータベースを作成しました！\n\n**Database Name**: ${process.env.DB_NAME}\n**Database URL**: ${process.env.DB_URL}\n\n> ⚠️ このデータベースはPRがクローズされると自動的に削除されます。`
            })
