name: Cleanup Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Delete Preview Database
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORG_SLUG: ${{ secrets.TURSO_ORG_SLUG }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          DB_NAME="next-lift-preview-pr${PR_NUMBER}-auth"

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰Šé™¤
          DELETE_RESPONSE=$(curl -X DELETE \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}")

          echo "Database deletion response: ${DELETE_RESPONSE}"

          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆ404ã¯æ—¢ã«å‰Šé™¤æ¸ˆã¿ã¨åˆ¤æ–­ï¼‰
          if echo "${DELETE_RESPONSE}" | jq -e '.error' > /dev/null; then
            ERROR_MSG=$(echo "${DELETE_RESPONSE}" | jq -r '.error')
            if [[ "${ERROR_MSG}" == *"not found"* ]]; then
              echo "Database ${DB_NAME} was already deleted or does not exist."
              exit 0
            else
              echo "Error deleting database: ${ERROR_MSG}"
              exit 1
            fi
          fi

          echo "Successfully deleted database: ${DB_NAME}"

      - name: Comment PR with Cleanup Info
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;

            const body = [
              '## ğŸ—‘ï¸ Preview Environment Cleaned Up',
              '',
              'âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼',
              '',
              `**Database Name**: next-lift-preview-pr${prNumber}-auth`,
              '',
              '> PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸãŸã‚ã€é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨Vercelç’°å¢ƒå¤‰æ•°ã‚’è‡ªå‹•çš„ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
