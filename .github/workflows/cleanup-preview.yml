name: Cleanup Preview

on:
  pull_request:
    types: [closed, unlabeled]

jobs:
  cleanup:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event.action == 'closed' ||
      (github.event.action == 'unlabeled' && github.event.label.name == 'with-preview')
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Pull Vercel Environment
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npx vercel pull --yes --environment=preview --token=$VERCEL_TOKEN

      - name: Delete Preview Database
        env:
          TURSO_PLATFORM_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORGANIZATION: ${{ secrets.TURSO_ORG_SLUG }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -a
          source .vercel/.env.preview.local
          set +a

          DB_NAME="next-lift-preview-pr${PR_NUMBER}-auth"

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆ404ã¯æˆåŠŸæ‰±ã„ï¼‰
          pnpm --filter @next-lift/turso run db:delete --name="${DB_NAME}"

          echo "Successfully deleted database: ${DB_NAME}"

      - name: Comment PR with Cleanup Info
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;

            const body = [
              '## ğŸ—‘ï¸ Preview Environment Cleaned Up',
              '',
              'âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼',
              '',
              `**Database Name**: next-lift-preview-pr${prNumber}-auth`,
              '',
              '> PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸãŸã‚ã€é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨Vercelç’°å¢ƒå¤‰æ•°ã‚’è‡ªå‹•çš„ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
