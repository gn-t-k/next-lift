name: Setup Preview

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  setup-database:
    name: Setup Preview Database
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      db_name: ${{ steps.create-db.outputs.db_name }}
      db_url: ${{ steps.create-db.outputs.db_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Create Preview Database
        id: create-db
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORG_SLUG: ${{ secrets.TURSO_ORG_SLUG }}
          TURSO_GROUP: ${{ secrets.TURSO_GROUP }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          DB_NAME="preview-pr${PR_NUMBER}-auth"

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŒç¶šè¡Œï¼‰
          CREATE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"${DB_NAME}\",\"group\":\"${TURSO_GROUP}\"}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases")

          echo "Database creation response: ${CREATE_RESPONSE}"

          # ä½œæˆæˆåŠŸæ™‚ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰Hostnameã‚’å–å¾—
          DB_HOSTNAME=$(echo "${CREATE_RESPONSE}" | jq -r '.database.Hostname // empty')

          # æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
          if [ -z "${DB_HOSTNAME}" ]; then
            echo "Database already exists or creation failed, fetching existing database info..."
            GET_RESPONSE=$(curl -s \
              -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
              "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}")
            echo "Database get response: ${GET_RESPONSE}"
            DB_HOSTNAME=$(echo "${GET_RESPONSE}" | jq -r '.database.Hostname')
          fi

          DB_URL="libsql://${DB_HOSTNAME}"
          echo "Database URL: ${DB_URL}"

          echo "db_name=${DB_NAME}" >> $GITHUB_OUTPUT
          echo "db_url=${DB_URL}" >> $GITHUB_OUTPUT

      - name: Create Database Token
        id: create-token
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_PLATFORM_API_TOKEN }}
          TURSO_ORG_SLUG: ${{ secrets.TURSO_ORG_SLUG }}
          DB_NAME: ${{ steps.create-db.outputs.db_name }}
        run: |
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆ
          TOKEN_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${TURSO_API_TOKEN}" \
            "https://api.turso.tech/v1/organizations/${TURSO_ORG_SLUG}/databases/${DB_NAME}/auth/tokens?expiration=never")

          echo "Token creation response (hidden for security)"

          # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
          DB_AUTH_TOKEN=$(echo "${TOKEN_RESPONSE}" | jq -r '.jwt')

          echo "db_auth_token=${DB_AUTH_TOKEN}" >> $GITHUB_OUTPUT

      - name: Set Vercel Environment Variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          DB_URL: ${{ steps.create-db.outputs.db_url }}
          DB_AUTH_TOKEN: ${{ steps.create-token.outputs.db_auth_token }}
          GIT_BRANCH: ${{ github.head_ref }}
        run: |
          # Vercelã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          # æ—¢å­˜ã®ç’°å¢ƒå¤‰æ•°ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ã‹ã‚‰ä½œæˆã™ã‚‹

          set_env_var() {
            local key=$1
            local value=$2

            # æ—¢å­˜ã®ç’°å¢ƒå¤‰æ•°ã‚’æ¤œç´¢
            EXISTING=$(curl -s \
              -H "Authorization: Bearer ${VERCEL_TOKEN}" \
              "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env?gitBranch=${GIT_BRANCH}" \
              | jq -r ".envs[] | select(.key == \"${key}\" and .gitBranch == \"${GIT_BRANCH}\") | .id // empty")

            if [ -n "${EXISTING}" ]; then
              echo "Deleting existing ${key} (id: ${EXISTING})..."
              curl -s -X DELETE \
                -H "Authorization: Bearer ${VERCEL_TOKEN}" \
                "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env/${EXISTING}"
            fi

            # æ–°ã—ã„ç’°å¢ƒå¤‰æ•°ã‚’ä½œæˆ
            echo "Creating ${key}..."
            RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer ${VERCEL_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"${key}\",\"value\":\"${value}\",\"type\":\"encrypted\",\"target\":[\"preview\"],\"gitBranch\":\"${GIT_BRANCH}\"}" \
              "https://api.vercel.com/v10/projects/${VERCEL_PROJECT_ID}/env")
            echo "Response: ${RESPONSE}"
          }

          set_env_var "TURSO_AUTH_DATABASE_URL" "${DB_URL}"
          set_env_var "TURSO_AUTH_DATABASE_AUTH_TOKEN" "${DB_AUTH_TOKEN}"

  deploy:
    name: Deploy to Vercel (Preview)
    needs: setup-database
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: Deploy to Vercel
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # --forceã§æ—¢å­˜ã®ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡è¦–ã—ã€ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ã‚’åæ˜ ã•ã›ã‚‹
          npx vercel deploy --token=$VERCEL_TOKEN --force > deployment-url.txt
          echo "DEPLOYMENT_URL=$(cat deployment-url.txt)" >> $GITHUB_ENV

      - name: Comment PR with Preview Info
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          DB_NAME: ${{ needs.setup-database.outputs.db_name }}
          DB_URL: ${{ needs.setup-database.outputs.db_url }}
        with:
          script: |
            const dbName = process.env.DB_NAME;
            const dbUrl = process.env.DB_URL;
            const deploymentUrl = process.env.DEPLOYMENT_URL;

            const body = [
              '## ğŸš€ Preview Environment Ready',
              '',
              'âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼',
              '',
              '### ğŸ—„ï¸ Database',
              `**Name**: ${dbName}`,
              `**URL**: ${dbUrl}`,
              '',
              '### ğŸŒ Deployment',
              `**Preview URL**: ${deploymentUrl}`,
              '',
              '> âš ï¸ ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¯PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
