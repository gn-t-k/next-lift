---
description: 現在のブランチのPRでCI失敗がある場合、ログを分析してエラー箇所と修正方針を報告します。
---

# check-ci カスタムコマンド

現在のブランチのPRに関連するCIの状態を確認し、失敗がある場合は原因を分析するコマンド。

## 実行手順

### 1. 現在のブランチとPRの確認

```bash
git branch --show-current
gh pr view --json number,title,state,statusCheckRollup
```

PRが存在しない場合は、その旨をユーザーに伝えて終了。

### 2. CIの状態確認

PRのチェック結果を取得:

```bash
gh pr checks
```

すべてpassしている場合は、「CIはすべて成功しています」と報告して終了。

### 3. 失敗したワークフローの詳細取得

失敗したチェックがある場合、ワークフロー実行IDを取得:

```bash
gh run list --branch <current-branch> --status failure --limit 5
```

### 4. サブエージェントに分析を依頼

**ci-log-analyzerサブエージェント**（@.claude/agents/ci-log-analyzer.md）を使用してログを分析する。

サブエージェントへの指示:
> 以下のワークフロー実行について、失敗原因を分析してください。
> - Run ID: <run-id>
> - Run ID: <run-id>
> ...

### 5. 分析結果の報告

サブエージェントからの分析結果をユーザーに報告し、以下を確認:

1. **ローカルで再現できるか**
   - @.claude/rules/error-handling.md に従い、修正前にローカルで再現することを推奨

2. **修正を開始するか**
   - ユーザーの同意後、最優先のエラーから修正を開始

## 注意事項

- CIに毎回プッシュして確認するのは非効率なので、必ずローカルで再現してから修正する
- 複数のエラーがある場合は、依存関係を考慮して優先度順に対応する
- ビルドエラーが解消しないと他のエラーも連鎖的に発生することがある
