# テスト開発ルール

テストコードを書く際に適用するルール。

## TDD開発フロー

新しくモジュールを実装する際は、以下のプロセスで進める:

1. **テストファースト**: まずテストを書く
2. **レビュー**: テストの内容をユーザーにレビューさせ、同意を得る
3. **実装**: テストを通すための最小限の実装を書く
4. **リファクタ**: テストが通る状態を保ちながらリファクタリング

目的: モジュールの実装前に、インターフェースや依存の設計を先に確定する

## テスト粒度

- テストコードも保守対象なので、数は最小限に留める
- **単体テスト**: 状態管理が複雑、または処理の分岐が多い場合のみ
- **統合テスト**: それ以外のケース（基本はこちらを優先）

## テスト構造

- describe/testの3階層構造: 機能名 → シナリオ分類 → 具体的なテスト
- describe/testは日本語で記述
- testは「〜こと」の形式で振る舞いを記述

## モックパターン

- 実装ファイルと同じディレクトリに `{機能名}.mock.ts` を配置
- `vi.spyOn()` でモジュール関数をスパイ
- 成功/失敗のモック関数を `mockXxxOk` / `mockXxxError` として公開

## テストデータ生成

- `@praha/drizzle-factory` を使用
- `testing/factories/` ディレクトリにファクトリを配置

## 統合テストのセットアップ

- `testing/setup.ts` でインメモリDBとグローバルセットアップを定義
- `vi.hoisted()` でモック前にDBを初期化
- `beforeEach` でテーブルをクリーンアップしマイグレーション実行

## ファイル配置

- テストファイル: 実装と同ディレクトリに `{機能名}.test.ts`
- モックファイル: 同ディレクトリに `{機能名}.mock.ts`
- ファクトリ: `testing/factories/`
- セットアップ: `testing/setup.ts`

## 参考実装

- `packages/authentication/` - 統合テストとモックパターン
- `packages/per-user-database/` - ファクトリとセットアップ
