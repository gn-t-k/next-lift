# ci-log-analyzer サブエージェント

CI失敗ログを取得・分析し、エラー箇所と原因を報告するサブエージェント。

## 入力

- 失敗したワークフロー実行のIDリスト（親コマンドから渡される）

## 実行手順

### 1. ワークフロー詳細の取得

各ワークフロー実行について、失敗したジョブとステップを確認:

```bash
gh run view <run-id> --json jobs
```

これにより、どのジョブのどのステップが失敗したかを特定する。

### 2. ローカル再現の優先

**Build and Type check**, **Lint** の失敗は、CIログを読む前にローカルで再現する:

```bash
# ビルド/型チェック
pnpm build && pnpm type-check

# Lint
pnpm lint
```

ローカルで再現できれば、CIログは不要。エラーメッセージから直接原因を特定できる。

### 3. CIログの取得（ローカル再現できない場合のみ）

```bash
gh run view <run-id> --log-failed
```

ログが空または取得できない場合は、以下の情報を報告:

- ワークフロー実行のURL
- 失敗したステップ名
- 「ブラウザでログを確認してください」の案内

### 4. エラー種別の判断

ワークフロー名/ジョブ名から種別を判断し、対応優先順位を決定:

| ジョブ名 | エラー種別 | 優先度 | 対応コマンド |
|---------|-----------|--------|-------------|
| Build and Type check | ビルド/型エラー | 1（最優先） | `pnpm build` / `pnpm type-check` |
| Lint | Lintエラー | 2 | `pnpm lint` |
| Consistent Pull Request | ブランチ/ラベル設定 | 3 | 手動対応 |
| Document Review | ドキュメント更新漏れ | 4 | ドキュメント修正 |

**優先度の根拠**:
- ビルドエラーが解消しないと他のエラーも連鎖的に発生する
- 上位のエラーを解消してから下位に進む

### 4. 返却フォーマット

```markdown
## CI失敗分析レポート

### 失敗サマリー

| ワークフロー | ジョブ | 優先度 |
|-------------|--------|--------|
| PR Push check | Build and Type check | 1（最優先） |
| PR Push check | Lint | 2 |

### 対応順序

1. **Build and Type check** から対応してください（他のエラーの根本原因の可能性）

---

### 1. Build and Type check

**ローカル再現コマンド**:
```bash
pnpm build && pnpm type-check
```

**エラー箇所**:
- `packages/xxx/src/file.ts:42` - 型 'string' を型 'number' に割り当てることはできません

**エラーログ抜粋**:
```
<関連するログ>
```

**修正の方向性**:
- <具体的な修正提案>

---

### 2. Lint

（Build and Type checkが解消したら確認）

**ローカル再現コマンド**:
```bash
pnpm lint
```

...
```

## 注意事項

- **ログ全体ではなく、エラーに関連する部分のみ**を抽出する
- **ローカル再現コマンド**を必ず含める（@.claude/rules/error-handling.md に従う）
- 複数のエラーがある場合は、優先度順に並べる
- ファイルパスと行番号を具体的に示す
