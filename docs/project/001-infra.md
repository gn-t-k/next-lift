# フェーズ1: インフラ基盤の整備 - タスクツリー

- [x] Turso Databaseの設定
  - [x] 環境ごとのデータベース戦略の決定
    - [x] 必要な環境の洗い出し（本番/開発/テスト/プレビュー）
    - [x] 各環境のデータベース構成の決定
    - [x] Per-User Database構成と環境戦略の整合性確認
    - [x] 環境変数の管理方法の決定
  - [x] Authentication Databaseの作成
    - [x] Tursoアカウントの作成/確認
    - [x] Turso CLIのインストール
    - [x] 各環境用のAuthentication Databaseインスタンスの作成
    - [x] 各環境のデータベース接続情報（URL、トークン）の取得
  - [x] Drizzle ORMのセットアップ
    - [x] auth-databaseパッケージの作成
      - [x] パッケージの初期化
      - [x] ルート `.env` へのシンボリックリンク作成
    - [x] Drizzle ORMとTurso用のドライバーのインストール
    - [x] Drizzle設定ファイルの作成
    - [x] TursoへのDrizzle接続設定
    - [x] 環境ごとの接続設定
    - [x] テスト用データベースのセットアップ
      - [x] ローカルテスト用DB環境の構築
      - [x] CI環境でのテストDB設定
      - [x] テスト用のDBリセット/シード機能
  - [x] Better Auth用スキーマの定義（Authentication DB）
    - [x] Better Authが必要とするテーブル構造の確認
    - [x] Drizzleスキーマファイルの作成（user, session, account, verification）
    - [x] マイグレーションファイルの生成
    - [x] マイグレーションの実行
    - [x] Better Auth設定の作成（packages/auth-database内）
      - [x] Better Authインスタンス設定ファイルの作成
      - [x] Drizzleアダプターの設定

- [x] Next.jsプロジェクトのセットアップ
  - [x] Next.jsのインストール（v16以上）
  - [x] App Routerの設定
  - [x] TypeScript設定
  - [x] リンター・フォーマッター設定
    - [x] Biome設定の継承/カスタマイズ
    - [x] Next.js向けルールの設定
  - [x] react-componentsパッケージの作成
    - [x] パッケージの初期化
    - [x] ルート `.env` へのシンボリックリンク作成
    - [x] 共通コンポーネントの基本構造
  - [x] 必要な依存パッケージのインストール
  - [x] Next.js MCP設定
    - [x] .mcp.jsonファイルの作成
    - [x] next-devtools-mcpの設定

- [x] Vercelへのデプロイ設定
  - [x] Vercelプロジェクトの作成
  - [x] 基本的なデプロイの動作確認
  - [x] プレビュー環境のデータベース管理
    - [x] PR作成時のデータベース作成（GitHub Actions）
      - [x] workflow作成（preview-db-create.yml）
      - [x] Turso Platform APIでpreview-pr{number}-authを作成
      - [x] GitHub Secretsの設定（TURSO_PLATFORM_API_TOKEN等）
      - [x] 動作確認
    - [x] PRクローズ時のデータベース削除（GitHub Actions）
      - [x] workflow作成（preview-db-delete.yml）
      - [x] preview-pr{number}-*を検索して削除
      - [x] 動作確認

- [x] エラー監視の設定
  - [x] Sentryのセットアップ
  - [x] Vercel IntegrationでSentryを連携
  - [x] エラー通知の設定
  - [x] エラー送信のテスト

- [x] Apple Developer Programのセットアップ（OAuth認証用）
  - [x] Apple Developer Programへの登録
  - [x] OAuth認証用のServices IDとクレデンシャル作成
  - [x] リダイレクトURLの設定（本番のみ、ローカルはApple非対応）

- [x] Google Cloud Consoleのセットアップ（OAuth認証用）
  - [x] Google Cloud Projectの作成
  - [x] OAuth 2.0クライアントIDの作成
  - [x] リダイレクトURLの設定（ローカル/本番/プレビュー）

- [x] Better Authによる認証基盤の構築
  - [x] Better AuthのNext.js統合（apps/web）
    - [x] Better AuthのRoute Handlerの作成
    - [x] apps/web内でのBetter Auth設定
      - [x] packages/authenticationのBetter Authインスタンスを利用
      - [x] プロバイダー設定の追加（Google, Apple）
    - [x] 環境変数の設定
      - [x] ローカル開発環境（.env）
      - [x] Vercel環境変数（本番/プレビュー）
    - [x] 基本動作確認（ローカル）
    - [x] データベーステーブルの作成
      - [x] マイグレーションファイルの適用
      - [x] development-auth.dbのシンボリックリンク設定
  - [x] OAuth認証フローの動作確認とエラーハンドリング
    - [x] Google OAuth認証のサインインフロー確認
      - [x] サインインページの作成
      - [x] Google OAuth認証の実装
      - [x] 認証コールバックの動作確認
    - [x] Apple OAuth認証のサインインフロー確認（本番環境でテスト予定）
    - [x] 初回サインイン時のユーザー作成確認
    - [x] 2回目以降のサインイン確認
    - [x] セッション管理の確認
      - [x] ダッシュボードページの作成
      - [x] セッション取得の実装
      - [x] サインアウト機能の実装
      - [x] 認証ガードの動作確認
    - [x] エラーハンドリングの実装
      - [x] 発生しうるエラーの洗い出しと分類
      - [x] ユーザー操作系エラーのUIフィードバック実装
      - [x] サーバ/設定系エラーのログ記録とSentry送信実装
      - [x] 各エラーケースの動作確認
  - [x] 本番環境へのマイグレーション実行
    - [x] .envの環境変数コメントアウトを解除
    - [x] packages/authenticationでpnpm migration:applyを実行
    - [x] マイグレーション成功の確認

- [x] iOSアプリの基本セットアップ
  - [x] Expo + React Nativeプロジェクトの作成
  - [x] TypeScript設定
  - [x] リンター・フォーマッター設定
  - [x] op-sqliteのインストール（libsql対応）
  - [x] Drizzle ORMのインストール
  - [x] EAS CLIのセットアップ
  - [x] Development Buildの設定（expo-dev-client）
  - [x] iOS Simulatorでの動作確認
  - [x] Drizzle ORM（op-sqlite）の詳細設定
    - [x] Drizzle設定ファイルの作成
    - [x] op-sqliteへのDrizzle接続設定
    - [x] ローカルSQLiteでの動作確認

- [x] Web/iOS/Tursoの連携基盤
  - [x] Per-User Database管理機能
    - [x] per-user-databaseパッケージの作成
      - [x] パッケージの初期化
      - [x] ルート `.env` へのシンボリックリンク作成
    - [x] Per-User DB用Drizzleスキーマの定義
    - [x] Turso Platform API統合（作成・削除）
    - [x] 初回サインイン時のPer-User DB作成フロー
    - [x] Per-User DB作成ロジックのテスト（モック使用）
  - [x] iOS: Better Auth統合
    - [x] @better-auth/expoのセットアップ
    - [x] iOS側での認証フロー実装
    - [x] セッション管理（expo-secure-store）
    - [x] サインイン・サインアウト機能の動作確認
  - [x] iOS: Turso Embedded Replicas
    - [x] op-sqliteでのEmbedded Replicas接続設定
      - [x] Per-User DBのURLとauthTokenを取得
      - [x] op-sqliteのopen()でローカルDB作成とリモート接続
      - [x] syncIntervalの設定
    - [x] Drizzle ORM（op-sqlite）との統合
      - [x] op-sqliteドライバーでDrizzleクライアント作成
      - [x] packages/per-user-databaseのスキーマを利用
    - [x] ローカル・リモート同期の動作確認
      - [x] 自動同期の確認（syncInterval）
      - [x] 手動同期（sync()）の確認
      - [ ] オフライン時の動作確認（実機で確認予定）
  - [x] Web/iOS間のデータ同期確認
    - [x] Webでデータ作成→iOSで参照の確認（手動）
    - [x] iOSでデータ作成→Webで参照の確認（手動）
    - [x] 同期タイミングの確認
    - [x] データ整合性の確認（欠損・重複がないか）
