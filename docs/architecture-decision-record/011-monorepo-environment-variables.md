# ADR-011: Monorepo環境変数管理（シンボリックリンク方式）

## ステータス

Accepted

## コンテキスト

Monorepo構成で、複数のパッケージ（apps/web、apps/ios、packages/*）が環境変数を参照する必要がある。環境変数の管理方法を決定する必要があった。

### 要件

- 環境変数を一元管理したい
- 各パッケージから環境変数にアクセスできる必要がある
- 秘密情報をGitにコミットしない
- 開発者が環境変数を簡単にセットアップできる

### 検討した選択肢

1. **各パッケージに個別の`.env`ファイルを配置**
2. **ルートの`.env`を各パッケージにシンボリックリンク**
3. **Next.jsの`.env.local`パターンを使用**

## 決定内容

**ルートに`.env`と`.env.example`を配置し、各パッケージにシンボリックリンクを作成する方式**を採用する。

### 構成

```plaintext
/
├── .env                      # 実際の環境変数（Gitで無視）
├── .env.example              # 環境変数のテンプレート（Gitで管理）
├── .gitignore                # .envを追加
├── apps/
│   ├── web/
│   │   └── .env -> ../../.env  # シンボリックリンク
│   └── ios/
│       └── .env -> ../../.env  # シンボリックリンク
└── packages/
    ├── authentication/
    │   └── .env -> ../../.env  # シンボリックリンク
    └── per-user-database/
        └── .env -> ../../.env  # シンボリックリンク
```

### セットアップ手順

1. ルートに`.env.example`をコピーして`.env`を作成
2. `.env`に実際の値を設定
3. 各パッケージ作成時にシンボリックリンクを作成

```bash
# パッケージディレクトリで実行
ln -s ../../.env .env
```

## 結果・影響

### メリット

1. **一元管理**
   - すべての環境変数が1ファイルで管理される
   - 変更が全パッケージに即座に反映される
   - 重複や不整合を防げる

2. **シンプルな運用**
   - 環境変数の追加・変更が1箇所で完結
   - `.env.example`を見れば必要な環境変数がすぐわかる
   - チーム開発時のセットアップが容易

3. **フレームワーク非依存**
   - Next.js、Expo、Node.jsすべてで`.env`を読み込める
   - フレームワーク特有の命名規則（`.env.local`等）に依存しない
   - シンプルで理解しやすい

4. **環境ごとの切り替えが容易**
   - 本番環境ではCI/CDやVercelの環境変数を使用
   - ローカル開発では`.env`を使用
   - 明確な分離

### デメリット

1. **シンボリックリンクの理解が必要**
   - Windowsでの動作に注意が必要（管理者権限が必要な場合がある）
   - Git cloneだけでは動作しない（`.env`の作成が必要）

2. **Next.jsの標準パターンと異なる**
   - Next.jsは`.env.local`、`.env.development`等の使用を推奨
   - しかし、Monorepo全体での一貫性を優先

3. **環境ごとの変数分離ができない**
   - 開発環境と本番環境で異なる値を持つ変数の管理は別途必要
   - ただし、本番環境はVercelの環境変数を使用するため問題ない

## 代替案

### 1. 各パッケージに個別の`.env`ファイルを配置

- **メリット**: パッケージごとに独立した設定が可能
- **却下理由**:
  - 環境変数の重複が発生
  - 変更時にすべてのファイルを更新する必要がある
  - 不整合のリスクが高い

### 2. Next.jsの`.env.local`パターンを使用

Next.jsが推奨する`.env.local`、`.env.development`、`.env.production`パターン

- **メリット**:
  - Next.js公式の推奨方法
  - 環境ごとの変数分離が容易
- **却下理由**:
  - **Monorepo全体での統一が困難**
  - Expo（React Native）は`.env.local`をサポートしていない
  - 過去の開発経験上、`.env.local`で特に利便性を感じたことがない
  - シンプルな`.env`の方が管理しやすい

## 決定日

2025-10-24
