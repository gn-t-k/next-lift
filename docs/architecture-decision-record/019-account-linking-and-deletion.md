# ADR-019: アカウントリンキングとアカウント削除

## ステータス

Accepted

## コンテキスト

Next Liftでは、Apple IDとGoogleの2つのソーシャルログインをサポートしている。現在の実装では、同じメールアドレスで登録していても、異なるプロバイダーでログインすると別々のアカウントとして作成されてしまう。

例えば、`example@gmail.com`でGoogleログインした場合と、同じ`example@gmail.com`でAppleログインした場合に、2つの別々のユーザーアカウントが作成される。これにより以下の問題が発生する:

- ユーザーが意図せず複数のアカウントを持ってしまう
- トレーニングデータが分散してしまう
- UXが悪い（どのプロバイダーでログインしたか覚えている必要がある）

また、アカウント削除機能が未実装であり、誤って作成されたアカウントを削除する手段がない。

## 決定内容

### 1. Account Linkingの有効化

Better Authの`accountLinking`機能を有効化し、同じメールアドレスを持つソーシャルアカウントを自動的にリンクする。これにより:

- 新規ログイン時、メールアドレスで既存ユーザーを検索
- 既存ユーザーが見つかり、かつプロバイダーがメール検証済みの場合
- 新しいユーザーを作成する代わりに、既存ユーザーに新しい`account`レコードを追加

### 2. アカウント削除機能の実装

Better Authの`deleteUser`機能を有効化し、ユーザーが自分のアカウントを削除できるようにする。

#### 削除範囲

- **削除対象**: 認証データのみ（`user`, `account`, `session`テーブル）
- **削除対象外**: Per-User Database

#### 削除対象外の理由

Per-User Databaseを認証データと同時に削除しない理由:

1. **データ復旧**: 誤削除時に認証だけ再作成すれば復旧可能
2. **段階的削除**: 即時削除と猶予期間後の削除を分離できる
3. **運用の柔軟性**: 定期バッチで古いPer-User DBを削除する設計が可能

将来的には、認証DBに紐づかない＋N日経過したPer-User DBを定期削除するバッチを実装予定。

#### UI/UXフロー

1. 設定画面に「アカウント削除」ボタンを配置
2. 確認ダイアログを表示
3. Better Authクライアントのアカウント削除APIを実行
4. サインイン画面にリダイレクト

認証方式がソーシャルログインのみ（パスワードなし）のため、フレッシュセッション（最近ログインしていれば即削除可能）方式を採用。

## 結果・影響

### メリット

- 同じメールアドレスで複数プロバイダーからログインしても同一アカウントとして扱われる
- ユーザーがどのプロバイダーでログインしたか覚えておく必要がない
- トレーニングデータが分散しない
- 誤って作成されたアカウントを削除できる
- Per-User DBを保持することでデータ復旧が可能

### デメリット

- Account Linkingには潜在的なセキュリティリスクがある（メール検証なしのプロバイダーを追加する場合は注意が必要）
- Per-User DBが残り続けるため、将来的にストレージコストが問題になる可能性がある

### セキュリティ考慮事項

Account Linkingの自動リンクはセキュリティリスクを伴うが、以下の理由で許容可能と判断:

1. GoogleとAppleはどちらもメール検証を行う信頼できるプロバイダー
2. Better Authはプロバイダーがメール検証済みの場合のみ自動リンクを行う
3. Slack、Discord、GitHubなど多くの大手サービスが同様のパターンを採用

## 代替案

### Account Linking

#### 手動リンクのみ

- **検討内容**: ユーザーが明示的にアカウントをリンクする
- **却下理由**: UXが悪い（設定画面で操作が必要）、銀行系ほどのセキュリティ要件はない

#### メールアドレスでの自動リンクを無効化

- **検討内容**: 現状維持（プロバイダーごとに別アカウント）
- **却下理由**: 同じユーザーのトレーニングデータが分散するのは本システムにとって致命的

### アカウント削除

#### Per-User DBも同時削除

- **検討内容**: 認証データとPer-User DBを同時に削除
- **却下理由**: 誤削除時のデータ復旧が不可能になる

#### 検証メールでの確認

- **検討内容**: 削除前にメールで確認URLを送信
- **却下理由**: 開発初期段階では過剰、将来必要になれば追加可能

## 決定日

2024-12-11
